# User Gallery & Firebase Storage Setup

## 🎯 What Was Implemented

### 1. Video Storage Library (`src/lib/video-storage.ts`)
Provides functions to manage user videos in Firestore:

- **`saveVideoToGallery()`** - Save generated video to user's gallery
- **`getUserVideos()`** - Fetch all videos for a user
- **`deleteVideoFromGallery()`** - Delete video from gallery
- **`updateVideoStatus()`** - Update video processing status

### 2. Database Structure

**Collection:** `videos`

```typescript
{
  id: string;              // Auto-generated by Firestore
  userId: string;          // Firebase Auth UID
  type: 'video' | 'image'; // Content type
  url: string;             // Video/image URL from Replicate
  thumbnailUrl?: string;   // Thumbnail (optional)
  prompt: string;          // Generation prompt
  model: string;           // Model ID (e.g., "luma/ray-flash-2-720p")
  modelName: string;       // Display name (e.g., "Luma Ray Flash 720p")
  duration?: string;       // Duration (e.g., "5s")
  aspectRatio?: string;    // Aspect ratio (e.g., "16:9")
  status: 'processing' | 'completed' | 'failed';
  error?: string;          // Error message if failed
  createdAt: Timestamp;    // Firebase server timestamp
  replicateId?: string;    // Replicate prediction ID
}
```

### 3. API Integration

**`/api/replicate/generate`** now:
1. Generates video with Replicate
2. Automatically saves to Firestore with all metadata
3. Links video to user's account
4. Returns `saved: true` in response

### 4. User Gallery Component

**`UserGallery.tsx`** now:
- Fetches real videos from Firebase
- Displays them in a responsive grid
- Supports filtering (all/video/image)
- Allows download and delete
- Shows loading states

---

## 🔧 Firebase Configuration Needed

### Step 1: Deploy Firestore Security Rules

1. Go to Firebase Console → Firestore Database → Rules
2. Copy the rules from `firestore.rules`
3. Click "Publish"

**Or use Firebase CLI:**
```bash
firebase deploy --only firestore:rules
```

### Step 2: Create Firestore Indexes

1. Go to Firebase Console → Firestore Database → Indexes
2. Copy configuration from `firestore.indexes.json`
3. Or use Firebase CLI:
```bash
firebase deploy --only firestore:indexes
```

**Required Indexes:**
- `videos` collection: `(userId ASC, createdAt DESC)`
- `videos` collection: `(userId ASC, status ASC, createdAt DESC)`

### Step 3: Verify Collection Setup

Your Firestore should have these collections:
- `users` - User profiles and credits
- `videos` - Generated videos/images per user

---

## 🎬 How It Works

### Generation Flow:

1. **User generates video**
   - Clicks "Generate" in UI
   - API deducts 1 credit

2. **Video generation**
   - Replicate processes video
   - Returns video URL

3. **Auto-save to Firebase**
   - API route saves video metadata
   - Links to user's `userId`
   - Status: `completed` or `failed`

4. **Display in gallery**
   - UserGallery fetches user's videos
   - Shows in responsive grid
   - Supports actions (download, delete)

### Query Performance:

- Videos ordered by `createdAt DESC` (newest first)
- Filtered by `userId` (security + performance)
- Composite index for fast queries

---

## 📊 Gallery Features

✅ **Implemented:**
- Real-time video fetching from Firebase
- Download videos
- Delete videos
- Filter by type (video/image)
- Responsive grid layout
- Loading states
- Error handling

🔜 **Future Enhancements:**
- Video thumbnails (extract first frame)
- Pagination (for users with 100+ videos)
- Search/filter by prompt
- Sort options (date, model, duration)
- Bulk operations
- Share videos

---

## 🧪 Testing

1. **Generate a video:**
   ```
   Prompt: "A serene sunset over mountains"
   Model: Any model
   Duration: 5s
   ```

2. **Check Firestore:**
   - Go to Firebase Console → Firestore
   - Check `videos` collection
   - Verify video document exists with your `userId`

3. **View in Gallery:**
   - Click "My Gallery" tab
   - See your generated video
   - Test download and delete

---

## 🔐 Security

- Users can only read/write their own videos
- Server-side rules enforce userId matching
- Admin SDK bypasses rules (for API operations)
- Client SDK respects rules (for user queries)

---

## 💾 Storage Costs

**Firestore Pricing (Free Tier):**
- 1 GB storage: Free
- 50K reads/day: Free
- 20K writes/day: Free
- 20K deletes/day: Free

**Typical Usage:**
- 1 video record ≈ 1KB
- 1,000 videos ≈ 1MB (well within free tier)
- User with 100 videos = 100 reads/view (within free tier)

---

## 🚀 Next Steps

1. Deploy Firestore rules and indexes
2. Test video generation
3. Verify gallery displays videos
4. Test download and delete
5. Monitor Firestore usage in console

**All code is deployed and ready!** Just need to configure Firebase rules. 🎉
